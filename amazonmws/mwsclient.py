# -*- coding: utf-8 -*-

""" Sample Order Report:
order-id	order-item-id	purchase-date	payments-date	buyer-email	buyer-name	buyer-phone-number	sku	product-name	quantity-purchased	currency	item-price	item-tax	shipping-price	shipping-tax	ship-service-level	recipient-name	ship-address-1	ship-address-2	ship-address-3	ship-city	ship-state	ship-postal-code	ship-country	ship-phone-number	tax-location-code	tax-location-city	tax-location-county	tax-location-state	per-unit-item-taxable-district	per-unit-item-taxable-city	per-unit-item-taxable-county	per-unit-item-taxable-state	per-unit-item-non-taxable-district	per-unit-item-non-taxable-city	per-unit-item-non-taxable-county	per-unit-item-non-taxable-state	per-unit-item-zero-rated-district	per-unit-item-zero-rated-city	per-unit-item-zero-rated-county	per-unit-item-zero-rated-state	per-unit-item-tax-collected-district	per-unit-item-tax-collected-city	per-unit-item-tax-collected-county	per-unit-item-tax-collected-state	per-unit-shipping-taxable-district	per-unit-shipping-taxable-city	per-unit-shipping-taxable-county	per-unit-shipping-taxable-state	per-unit-shipping-non-taxable-district	per-unit-shipping-non-taxable-city	per-unit-shipping-non-taxable-county	per-unit-shipping-non-taxable-state	per-unit-shipping-zero-rated-district	per-unit-shipping-zero-rated-city	per-unit-shipping-zero-rated-county	per-unit-shipping-zero-rated-state	per-unit-shipping-tax-collected-district	 per-unit-shipping-tax-collected-city	per-unit-shipping-tax-collected-county	per-unit-shipping-tax-collected-state	item-promotion-discount	item-promotion-id	ship-promotion-discount	ship-promotion-id	delivery-start-date	delivery-end-date	delivery-time-zone	delivery-Instructions	sales-channel
113-0132185-7763468	49867438371106	2013-11-06T10:05:33-08:00	2013-11-06T10:05:33-08:00	10zlwn9nypqx7p7@marketplace.amazon.com	john salas	301-659-0945	11904	Advanced-Q Ubiquinol with VESIsorbï¿½.	2	USD	69.90	0.00	3.00	0.00	Standard	john salas	1402 LINWOOD DR			SALINAS	CALIFORNIA	93906-3348	US	301-659-0945	050532950	SALINAS	MONTEREY	CA	0.00	0.00	0.00	0.00	69.90	69.90	69.90	69.90	0.00	0.00	0.00	0.00	0.00	0.00	0.00	0.00	0.00	0.00	0.00	0.00	3.00	3.00	3.00	3.00	0.00	0.00	0.00	0.00	0.00	0.00	0.00	0.00	0.00		0.00
002-0854791-5713047	20069603398042	2013-11-06T16:08:44-08:00	2013-11-06T16:08:44-08:00	1fb2xks5g88jpyz@marketplace.amazon.com	michele  j derby	9514610658	10400	Nutri-Health Flora Source Multi-Probiotic Capsules	1	USD	31.89	0.00	3.00	0.00	Standard	michele  j derby	39055 LOS GATOS DR			MURRIETA	CA	92563-7871	US	9514610658	050650000	NOT APPLICABLE	RIVERSIDE	CA	0.00	0.00	0.00	0.00	31.89	0.00	31.89	31.89	0.00	31.89	0.00	0.00	0.00	0.00	0.00	0.00	0.00	0.00	0.00	0.00	3.00	0.00	3.00	3.00	0.00	3.00	0.00	0.00	0.00	0.00	0.00	0.00	0.00		0.00
115-0228129-6839434	34900468135626	2013-11-06T17:52:31-08:00	2013-11-06T17:52:31-08:00	zsp6rb8m7csp6zv@marketplace.amazon.com	Joyce O'Brien	402-330-1849	10503	Nutri-Health ArthroZyme Plus Joint & Muscle	1	USD	34.95	0.00	3.00	0.00	Standard	Joyce O'Brien	10005 SPRAGUE ST			OMAHA	NE	68134-3714	US	402-330-1849	280550300	OMAHA	DOUGLAS	NE	0.00	0.00	0.00	0.00	0.00	34.95	34.95	34.95	34.95	0.00	0.00	0.00	0.00	0.00	0.00	0.00	0.00	0.00	0.00	0.00	0.00	3.00	3.00	3.00	3.00	0.00	0.00	0.00	0.00	0.00	0.00	0.00	0.00		0.00
105-9040681-0305822	27284087417610	2013-11-06T19:39:15-08:00	2013-11-06T19:39:15-08:00	m5zh9952mpj4z67@marketplace.amazon.com	Tim M Lother	425-821-7771	10404	Nutri-Health Flora Sinus Seasonal Support	1	USD	33.99	0.00	3.00	0.00	Standard	Tim Lother	13313 NE 135TH ST			KIRKLAND	WA	98034-5529	US	425-821-7771	480330330	KIRKLAND	KING	WA	0.00	0.00	0.00	0.00	33.99	33.99	33.99	33.99	0.00	0.00	0.00	0.00	0.00	0.00	0.00	0.00	0.00	0.00	0.00	0.00	3.00	3.00	3.00	3.00	0.00	0.00	0.00	0.00	0.00	0.00	0.00	0.00	0.00		0.00
103-6574985-0839418	12799697129170	2013-11-07T07:30:24-08:00	2013-11-07T07:30:24-08:00	5vqc737bdml7jgc@marketplace.amazon.com	Larry Organski	315-369-4443	10404	Nutri-Health Flora Sinus Seasonal Support	1	USD	33.99	0.00	3.00	0.00	Standard	Shellie Organski	4307 Lakeview Drive			Otter Lake	New York	13338-3412	US	315-369-4443	330650000	NOT APPLICABLE	ONEIDA	NY	0.00	0.00	0.00	0.00	0.00	0.00	33.99	33.99	33.99	33.99	0.00	0.00	0.00	0.00	0.00	0.00	0.00	0.00	0.00	0.00	0.00	0.00	3.00	3.00	3.00	3.00	0.00	0.00	0.00	0.00	0.00	0.00	0.00		0.00
106-9562677-6256207	62961143059626	2013-11-07T07:46:52-08:00	2013-11-07T07:46:52-08:00	yfm8pvgcnvjhh2d@marketplace.amazon.com	Edwin R Cole	214-729-1580	10501	Nutri-Health ArthroZyme Joint & Muscle	1	USD	39.95	0.00	3.00	0.00	Standard	Edwin R Cole	3186 Ritchie Creek Rd			Blue Ridge	GA	30513	US	214-729-1580	111110000	NOT APPLICABLE	FANNIN	GA	0.00	0.00	0.00	0.00	0.00	0.00	39.95	39.95	39.95	39.95	0.00	0.00	0.00	0.00	0.00	0.00	0.00	0.00	0.00	0.00	0.00	0.00	3.00	3.00	3.00	3.00	0.00	0.00	0.00	0.00	0.00	0.00	0.00		0.00
"""

import logging
from csv import reader
from StringIO import StringIO

from boto import set_stream_logger
from boto.mws import connection
from boto.mws.exception import ResponseError

ORDER_REPORT_FIELDS = [
    'order-id',
    'order-item-id',
    'purchase-date',
    'payments-date',
    'buyer-email',
    'buyer-name',
    'buyer-phone-number',
    'sku',
    'product-name',
    'quantity-purchased',
    'currency',
    'item-price',
    'item-tax',
    'shipping-price',
    'shipping-tax',
    'ship-service-level',
    'recipient-name',
    'ship-address-1',
    'ship-address-2',
    'ship-address-3',
    'ship-city',
    'ship-state',
    'ship-postal-code',
    'ship-country',
    'ship-phone-number',
    'tax-location-code',
    'tax-location-city',
    'tax-location-county',
    'tax-location-state',
    'per-unit-item-taxable-district',
    'per-unit-item-taxable-city',
    'per-unit-item-taxable-county',
    'per-unit-item-taxable-state',
    'per-unit-item-non-taxable-district',
    'per-unit-item-non-taxable-city',
    'per-unit-item-non-taxable-county',
    'per-unit-item-non-taxable-state',
    'per-unit-item-zero-rated-district',
    'per-unit-item-zero-rated-city',
    'per-unit-item-zero-rated-county',
    'per-unit-item-zero-rated-state',
    'per-unit-item-tax-collected-district',
    'per-unit-item-tax-collected-city',
    'per-unit-item-tax-collected-county',
    'per-unit-item-tax-collected-state',
    'per-unit-shipping-taxable-district',
    'per-unit-shipping-taxable-city',
    'per-unit-shipping-taxable-county',
    'per-unit-shipping-taxable-state',
    'per-unit-shipping-non-taxable-district',
    'per-unit-shipping-non-taxable-city',
    'per-unit-shipping-non-taxable-county',
    'per-unit-shipping-non-taxable-state',
    'per-unit-shipping-zero-rated-district',
    'per-unit-shipping-zero-rated-city',
    'per-unit-shipping-zero-rated-county',
    'per-unit-shipping-zero-rated-state',
    'per-unit-shipping-tax-collected-district',
    'per-unit-shipping-tax-collected-city',
    'per-unit-shipping-tax-collected-county',
    'per-unit-shipping-tax-collected-state',
    'item-promotion-discount',
    'item-promotion-id',
    'ship-promotion-discount',
    'ship-promotion-id',
    'delivery-start-date',
    'delivery-end-date',
    'delivery-time-zone',
    'delivery-Instructions',
    'sales-channel']


class MWS:
    """Amazon Marketplace Web Service (MWS) client proxy"""
    def __init__(self, seller_id, aws_access_key_id, aws_secret_access_key):
        set_stream_logger('boto')
        self.mws = connection.MWSConnection(
            SellerId=seller_id,
            aws_access_key_id=aws_access_key_id,
            aws_secret_access_key=aws_secret_access_key)

    def get_report_list(self):
        """MWS GetReportList/2009-01-01 API call; quota=10 restore=60.00
        Returns a list of reports that were created in the previous 90 days
        that match the query parameters.
        """
        try:
            reports = self.mws.get_report_list()
            report_infos = reports.GetReportListResult.ReportInfo
            report_ids = [report_info.ReportId for report_info in report_infos]
            return report_ids
        except ResponseError as e:
            logging.error(e.message)

    def get_report(self, report_id):
        """MWS GetReport/2009-01-01 API call; quota=15 restore=60.00
        Returns the contents of a report."""
        report = self.mws.get_report(ReportId=report_id)
        data = []
        f = StringIO(report)
        f.readline()  # skip header row
        for row in reader(f, delimiter='\t'):
            #fields = dict((field, '') for field in row)
            #break
            zipped = zip(ORDER_REPORT_FIELDS, row)
            data.append(zipped)
        return data
